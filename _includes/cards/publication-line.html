{% assign publication = include.item %}
{% assign link_url = include.link_url | default: '' %}
{% assign default_label = 'Open ' | append: publication.title %}
{% assign link_label = include.link_label | default: default_label %}

<li class="stacked-publications__item">
  <span class="stacked-publications__year">{{ publication.date | date: "%Y" }}</span>
  <div class="stacked-publications__details">
    <p class="stacked-publications__title">
      <span class="stacked-publications__title-text">{{ publication.title }}</span>
      {% if link_url != '' %}
        <a class="stacked-publications__title-link"
           href="{{ link_url }}"
           {% if include.link_external %}target="_blank" rel="noopener"{% endif %}
           aria-label="{{ link_label }}">
          <i class="fas fa-link" aria-hidden="true"></i>
          <span class="visually-hidden">{{ link_label }}</span>
        </a>
      {% endif %}
    </p>
    {% if publication.venue %}
      <p class="stacked-publications__venue">
        {{ publication.venue }}{% if publication.volume %}, {{ publication.volume }}{% endif %}{% if publication.pages %}, {{ publication.pages }}{% endif %}
      </p>
    {% endif %}
    {% if publication.authors %}
      {% assign my_last_name = site.author.last | default: "Chica" %}
      {% assign author_list = publication.authors | split: " and " %}
      {% assign author_count = author_list | size %}
      {% assign formatted_authors = "" %}
      {% for author in author_list %}
        {% assign author_trimmed = author | strip %}
        {% assign name_parts = author_trimmed | split: ", " %}
        {% assign last_name = name_parts[0] | strip %}
        {% assign first_names = name_parts[1] | strip | split: " " %}

        {% assign initials = "" %}
        {% assign has_asterisk = false %}
        {% for name in first_names %}
          {% if name contains "*" %}
            {% assign has_asterisk = true %}
            {% assign name = name | remove: "*" %}
          {% endif %}
          {% assign first_char = name | slice: 0 %}
          {% assign initials = initials | append: first_char | append: "." %}
        {% endfor %}
        {% if has_asterisk %}
          {% assign initials = initials | append: "*" %}
        {% endif %}

        {% assign author_index = forloop.index %}
        {% assign add_cofirst = false %}
        {% if publication.cofirst == true and publication.cofirstnumber %}
          {% if author_index <= publication.cofirstnumber %}
            {% assign add_cofirst = true %}
          {% endif %}
        {% endif %}
        {% assign add_corresponding = false %}
        {% if publication.corresponding == true and publication.correspondingnumber %}
          {% assign corresponding_start = author_count | minus: publication.correspondingnumber %}
          {% if author_index > corresponding_start %}
            {% assign add_corresponding = true %}
          {% endif %}
        {% endif %}

        {% if last_name contains my_last_name %}
          {% assign formatted_author = "<strong>" | append: last_name | append: ", " | append: initials | append: "</strong>" %}
        {% else %}
          {% assign formatted_author = last_name | append: ", " | append: initials %}
        {% endif %}

        {% if add_cofirst %}
          {% assign formatted_author = formatted_author | append: "<sup>â€ </sup>" %}
        {% endif %}
        {% if add_corresponding %}
          {% assign formatted_author = formatted_author | append: "<sup>*</sup>" %}
        {% endif %}

        {% if forloop.first %}
          {% assign formatted_authors = formatted_author %}
        {% elsif forloop.last %}
          {% assign formatted_authors = formatted_authors | append: " & " | append: formatted_author %}
        {% else %}
          {% assign formatted_authors = formatted_authors | append: ", " | append: formatted_author %}
        {% endif %}
      {% endfor %}
      <p class="stacked-publications__authors">{{ formatted_authors }}</p>
    {% endif %}
  </div>
</li>
